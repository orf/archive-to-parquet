[tools]
python = "3.12"
rust = "stable"
"cargo:https://github.com/cross-rs/cross" = { version = "branch:main", crate = "cross" }

[tasks.test-data-gping]
description = "Download gping source code"
shell = 'bash -c'
run = [
    "mkdir -p test_data/gping/",
    "rm -f test_data/gping/*",
    "curl -L https://github.com/orf/gping/archive/e66b02167fa0cb2c5bae957e730d19ac9c22de47.zip > test_data/gping/archive.zip",
    "curl -L https://github.com/orf/gping/archive/e66b02167fa0cb2c5bae957e730d19ac9c22de47.tar.gz > test_data/gping/archive.tar.gz",
    "cat test_data/gping/archive.tar.gz | gzip -d > test_data/gping/archive.tar"
]

[tasks.cross-build]
description = "Build cross"
run = 'echo cross build --target={{option(name="target")}} --locked {{arg()}}'

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench --quiet -F bench"
depends = ["test-data-linux", "test-data-gping"]
env = { RUST_BACKTRACE = '1' }

[tasks.bench-opt]
description = "Run benchmarks"
run = "cargo bench --quiet -F bench --profile=bench-opt"
depends = ["test-data-linux", "test-data-gping"]
env = { RUSTFLAGS = '-C target_cpu=native', RUST_BACKTRACE = '1' }

[tasks.flamegraph]
description = "Generate flamegraph profile"
run = """
cargo flamegraph -f bench --root --profile=flamegraph -- \
    /dev/null test_data/python/blobs/sha256/ --unique --compression=uncompressed
"""
depends = ["test-data-docker"]
env = { RUSTFLAGS = '-C target_cpu=native', RUST_BACKTRACE = '1' }

[tasks.build-release]
description = "Build release"
run = "cargo build --release --bins"
